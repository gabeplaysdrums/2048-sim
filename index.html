<!DOCTYPE html>
<html>
  <head>
    <title>2048 simulator</title>
    <link rel="stylesheet" href="css/game.css" />
    <link rel="stylesheet" href="css/jqplot/jquery.jqplot.min.css" />
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/jsrender.min.js"></script>
    <script src="js/game.js"></script>
    <script src="js/player.js"></script>
    <script src="js/genetics.js"></script>
    <script src="js/jqplot/jquery.jqplot.min.js"></script>
    <style type="text/css">

    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial;
      font-size: 11pt;
    }

    .game.best {
      background-color: yellow;
    }

    #controls {
      position: fixed;
      height: 100%;
      top: 0;
      left: 0;
      display: block;
    }

    #controls-pane {
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.95);
      width: 500px;
      height: 100%;
      overflow: auto;
      border-right: 5px solid lightgray;
      display: inline-block;
    }

    #controls-toggle {
      display: inline-block;
      background-color: lightgray;
      vertical-align: top;
      text-align: center;
      padding: 5px;
      padding-top: 20px;
      padding-bottom: 20px;
      padding-right: 8px;
      margin-top: 5px;
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
      text-decoration: inherit;
      font-family: monospace;
      color: rgb(100, 100, 100);
      font-weight: bold;
    }

    #controls-toggle:before {
      content: "<<";
    }

    #controls-toggle.collapsed:before {
      content: ">>";
    }

    #games {
      padding-left: 30px;
    }

    #leaderboard th {
      text-align: left;
      text-decoration: underline;
      padding-right: 10px;
    }

    #leaderboard-entries .entry .name {
      font-weight: bold;
    }

    #leaderboard-entries .entry td {
      padding-right: 10px;
    }

    #leaderboard-entries .entry .score {
      text-align: right;
    }

    #leaderboard-entries .entry .move-count {
      text-align: right;
    }

    #leaderboard-entries .entry .highest-tiles {
      text-align: right;
    }


    #player-leaderboard th {
      text-align: left;
      text-decoration: underline;
      padding-right: 10px;
    }

    #player-leaderboard-entries .entry .name a {
      color: inherit;
      text-decoration: inherit;
    }

    #player-leaderboard-entries .entry .name {
      font-weight: bold;
    }

    #player-leaderboard-entries .entry td {
      padding-right: 10px;
    }

    #player-leaderboard-entries .entry .move-count {
      text-align: right;
    }

    #player-leaderboard-entries .entry .min {
      text-align: right;
    }

    #player-leaderboard-entries .entry .mean {
      text-align: right;
    }

    #player-leaderboard-entries .entry .max {
      text-align: right;
    }

    #player-leaderboard-entries .entry .fitness {
      text-align: right;
    }

    #chart {
      margin-left: 40px;
      height: 300px;
    }

    </style>
    <script type="text/javascript">

    var leaderboard = [];
    var bestPlayers = [];

    var POPULATION_SIZE = 10;
    var NUM_GAMES = 24;
    var RENDER_GAMES = 3;
    var CROSSOVER_RATE = 0.8;
    var MUTATION_RATE = 0.05;
    var TOP_N = 3;

    var population = [];
    var playerStats = {};
    var tickTimer = null;

    function copyGenome(name)
    {
        var genomeString = encodeGenome(playerStats[name].player.genes());
        window.prompt("Copy to clipboard: Ctrl+C, Enter", genomeString);
    }

    $(function() {

        var chartData = [ [], [], [] ];

        function renderChart(data)
        {
            $("#chart").empty();
            $.jqplot("chart", data, {
                axes: {
                    xaxis: {
                        pad: 0,
                    },
                },
                seriesDefaults: {
                    markerOptions: {
                        show: false,
                    },
                },
            });

        }

        renderChart([ [0], [0], [0] ]);

        function toggleControls()
        {
            $("#controls-pane").toggle();
            $("#controls-toggle").toggleClass("collapsed");
        }

        $("#controls-toggle").click(toggleControls);
        toggleControls();

        function StatsCollection()
        {
            var self = this;
            var data = [];

            this.addData = function(score) {
                data.push(score);
                data.sort(function(a, b) { return a - b; });
            }

            this.min = function() {
                return (data.length > 0) ? data[0] : null;
            };

            this.max = function() {
                return (data.length > 0) ? data[data.length - 1] : null;
            };

            this.median = function() {

                if (data.length === 0)
                {
                    return null;
                }

                var i = Math.floor(data.length / 2);

                if (data.length % 2 === 0)
                {
                    return (data[i] + data[i + 1]) / 2;
                }

                return data[i];
            };

            this.mean = function() {

                var sum = 0;

                for (var i=0; i < data.length; i++)
                {
                    sum += data[i];
                }

                return sum / data.length;
            };

            this.count = function() {
                return data.length;
            };
        }

        function runSimulation(player, callback)
        {
            var completedCount = 0;

            if (!playerStats[player.name()])
            {
                playerStats[player.name()] = {
                    "player": player,
                    "stats": new StatsCollection(),
                    "fitness": 0,
                };
            }

            var stats = playerStats[player.name()].stats;

            $("#games").empty();

            for (var i=0; i < NUM_GAMES; i++)
            {
                var render = (
                    $("#render-games").is(":checked") && 
                    i < RENDER_GAMES
                );

                var engine = new GameEngine(player.name(), null, render);
                var $game = engine.elem();

                if (!$game)
                {
                    $game = $("<div/>").addClass("game").hide();
                }

                $game.prop("engine", engine);
                $game.prop("player", player);
                $("#games").append($game);
    
                engine.oncompleted = function(engine) {
    
                    var name = player.name();
    
                    stats.addData(engine.score());
    
                    var h = engine.state().highest();
    
                    leaderboard.push({
                        "name": name,
                        "score": engine.score(),
                        "moveCount": engine.moveCount(),
                        "maxValue": engine.state().maxValue(),
                        "highest": [ h[0], h[1], h[2] ].join(", "),
                    });
                    
                    leaderboard.sort(function(a, b) { return b["score"] - a["score"]; });
                    $("#leaderboard-entries").empty();
    
                    for (var i=0; i < leaderboard.length && i < 25; i++)
                    {
                        var $container = $("<div />")
                            .html($("#leaderboard-entry-template")
                            .render(leaderboard[i]));
                        var $entry = $container.children().first();
                        $("#leaderboard-entries").append($entry);
                    }
    
                    $("#completed-count").text(leaderboard.length);
    
                    completedCount++;
    
                    if (completedCount === NUM_GAMES)
                    {
                        callback(player, stats);
                    }
                };
            }
        }

        $.views.tags("decimal3", function(value) {
            return value.toFixed(3);
        });

        function tick()
        {
            var best = null;

            $.each($(".game"), function(i, elem) {

                if (!elem.engine.state().completed())
                {
                    var dir = elem.player.chooseMove(elem.engine.state());
    
                    if (dir)
                    {
                        elem.engine.applyMove(dir);
                    }
    
                    if (!best || elem.engine.score() > best.engine.score())
                    {
                        best = elem;
                    }
                }

            });

            $(".game").removeClass("best");
            $(best).addClass("best");
        }

        tickTimer = window.setInterval(tick, 0);
        //$(window).click(tick);

        // initial population
        {
            var allfather = new GeneticPlayer(SNAKE_GENES);

            population.push({
                "player": allfather,
                "fitness": 0,
            });

            while (population.length < 2 * POPULATION_SIZE)
            {
                var children = allfather.mate(allfather, 0, 0.2);

                for (var j=0; j < children.length; j++)
                {
                    population.push({
                        "player": children[j],
                        "fitness": 0,
                    });
                }
            }
        }

        function breed()
        {
            var newPopulation = [];

            population.sort(function(a, b) { return b.fitness - a.fitness; });

            for (var i=0; i < TOP_N; i++)
            {
                newPopulation.push(population[i]);
            }

            while (newPopulation.length < POPULATION_SIZE)
            {
                var male = chooseFittest(population, TOP_N).player;
                var female = chooseFittest(population, TOP_N).player;
                var children = male.mate(female, CROSSOVER_RATE, MUTATION_RATE);

                while (children.length > 0)
                {
                    newPopulation.push({
                        "player": children[0],
                        "fitness": 0,
                    });
                    children.shift();
                }
            }

            population = newPopulation;
        }

        function nextGeneration(genIndex)
        {
            console.log("----- Generation " + genIndex + " -----");

            var genStats = new StatsCollection();
    
            function nextSimulation(popIndex)
            {
                var player = population[popIndex].player;
    
                runSimulation(player, function(player, stats) {
                    var fitness = stats.min() + 2 * stats.mean() + stats.max();

                    population[popIndex].fitness = fitness;
                    genStats.addData(fitness);
                    playerStats[player.name()].fitness = fitness;

                    console.log(
                        player.name() + 
                        ": min= " + stats.min().toFixed(3) +
                        ", mean= " + stats.mean().toFixed(3) + 
                        ", max= " + stats.max().toFixed(3) +
                        ", median= " + stats.median().toFixed(3) + 
                        ", fitness= " + population[popIndex].fitness.toFixed(3)
                    );
    
                    popIndex++;
    
                    if (popIndex < population.length)
                    {
                        window.setTimeout(function(){ nextSimulation(popIndex); }, 0);
                    }
                    else
                    {
                        chartData[0].push(genStats.max());
                        chartData[1].push(genStats.min());
                        chartData[2].push(genStats.mean());

                        renderChart(chartData);

                        while (bestPlayers.length > 0)
                        {
                            bestPlayers.pop();
                        }

                        for (var name in playerStats)
                        {
                            var stats = playerStats[name].stats;

                            bestPlayers.push({
                                "name": name,
                                "count": stats.count(),
                                "min": stats.min(),
                                "mean": stats.mean(),
                                "max": stats.max(),
                                "fitness": playerStats[name].fitness,
                            });
                        }

                        bestPlayers.sort(function(a, b) { return b.fitness - a.fitness; });
                        $("#player-leaderboard-entries").empty();
        
                        for (var i=0; i < bestPlayers.length && i < 25; i++)
                        {
                            var $container = $("<div />")
                                .html($("#player-leaderboard-entry-template")
                                .render(bestPlayers[i]));
                            var $entry = $container.children().first();
                            $("#player-leaderboard-entries").append($entry);
                        }
        
                        $("#player-count").text(bestPlayers.length);

                        genIndex++;
                        breed();
                        window.setTimeout(function() { nextGeneration(genIndex); }, 0);
                    }
                });
            }
    
            nextSimulation(0);
        }

        nextGeneration(0);

    });

    </script>
  </head>
  <body>
    <div id="chart"></div>
    <div id="games">
    </div>
    <div id="controls">
      <div id="controls-pane">
        <div>
          <input id="render-games" type="checkbox" checked>
          render games
        </div>
        <div id="player-leaderboard">
          <h3>Best Players (Top 25 of <span id="player-count">0</span>)</h3>
          <table>
            <tr>
              <th>name</th>
              <th>games</th>
              <th>min</th>
              <th>mean</th>
              <th>max</th>
              <th>fitness</th>
            </tr>
            <tbody id="player-leaderboard-entries">
            </tbody>
          </table>
        </div>
        <div id="leaderboard">
          <h3>Best Games (Top 25 of <span id="completed-count">0</span>)</h3>
          <table>
            <tr>
              <th>player</th>
              <th>score</th>
              <th>moves</th>
              <th>highest</th>
            </tr>
            <tbody id="leaderboard-entries">
            </tbody>
          </table>
        </div>
      </div><a id="controls-toggle" href="javascript:void(0);"></a>
    </div>
    <script id="leaderboard-entry-template" type="text/x-jsrender">
      <tr class="entry">
        <td class="name">{{:name}}</td>
        <td class="score">{{decimal3 score /}}</td>
        <td class="move-count">{{:moveCount}}</td>
        <td class="highest-tiles">{{:highest}}</td>
      </tr>
    </script>
    <script id="player-leaderboard-entry-template" type="text/x-jsrender">
      <tr class="entry">
        <td class="name">
          <a href="javascript:copyGenome('{{:name}}');">{{:name}}</a>
        </td>
        <td class="game-count">{{:count}}</td>
        <td class="min">{{decimal3 min /}}</td>
        <td class="mean">{{decimal3 mean /}}</td>
        <td class="max">{{decimal3 max /}}</td>
        <td class="fitness">{{decimal3 fitness /}}</td>
      </tr>
    </script>
    <script id="game-template" type="text/x-jsrender">
      <div class="game">
        <div class="stats">
          <div class="label"></div>
          <div>moves: <span class="move-count">?</span></div>
          <div>max value: <span class="max-value">?</span></div>
          <div>sum values: <span class="sum-values">?</span></div>
          <div>score: <span class="score">?</span></div>
        </div>
        <table>
          <tr>
            <td></td><td></td><td></td><td></td>
          </tr>
          <tr>
            <td></td><td></td><td></td><td></td>
          </tr>
          <tr>
            <td></td><td></td><td></td><td></td>
          </tr>
          <tr>
            <td></td><td></td><td></td><td></td>
          </tr>
        </table>
      </div>
    </script>
  </body>
</html>
